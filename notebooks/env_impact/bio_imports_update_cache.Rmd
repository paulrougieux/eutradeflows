---
title: "Environmental impact of EU imports."
author: "Paul Rougieux"
date: "18 March 2018"
output:
  pdf_document: 
    number_sections: yes
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir="../..") # file paths are relative to the root of the project directory
library(eutradeflows)
library(dplyr)
library(tidyr)
library(ggplot2)
con <- RMariaDB::dbConnect(RMariaDB::MariaDB(), dbname = "tradeflows")
```


# Introduction


The purpose of this document is to update the cache in the form of rds files so the data
can be analysed on machines which do not have a database installation. 


See if the data can be loaded in memory. 

Pre processing of the input data:
* The imput data is loaded from comext is loaded to the database with the trade harvester package.
    see docs/harvest under the tradeharvester package. 
    section 2020 update, subsection on the laptop.
* It is then prepared and aggregated in a R script called R/env_impact.R


Object size 
* with 7 products 
    * object size before the filter and select statement 1.4 GB.
    * Object size after the filter and select statement 107.2 Mb.
* with 63 products 738.4 Mb and as rds file uses 87Mb.

# Download from Comext and transfer to DB

See tradeharvester/notebooks/harvest.Rmd, 
the section on 2020 update on the laptop.
involves the use of `transfer7zfolder2db`, `harvestcomextmetadata` and `eutradeflows::cleanallcomextcodes`

# From the DB to the cache
## Load from database and update metadata cache 

Note metadata is loaded first here, since EU country codes are used later in the data query. 
```{r eval=FALSE}
# Load partner country codes and names
partner_names <- tbl(con, 'vld_comext_partner') %>% collect()
# Fix character encoding issue in Laos name (see Latex error in bio_imports_main_partner_countries.Rmd)
partner_names$partner[grepl("Lao", partner_names$partner)] <- "Lao"

# Load reporter country codes and names
reporter_names <- tbl(con, 'vld_comext_reporter') %>% collect()
# Load product codes and names
product_names <- tbl(con, 'vld_comext_product') %>% collect()
# Fix character encoding issue in some product names
product_names$productdescription <- gsub("�"," ", product_names$productdescription)
# The issue is not only with this "├" special character but also with those that follow 
# Truncate those to 40 characters
product_names$productdescription <- ifelse(grepl("├",product_names$productdescription),
       substr(product_names$productdescription,1,40),
       product_names$productdescription)

# Save the metadata in rds cache files
saveRDS(partner_names, "data_raw/env_impact/partner_names.rds")
saveRDS(reporter_names, "data_raw/env_impact/reporter_names.rds")
saveRDS(product_names, "data_raw/env_impact/product_names.rds")

# List of EU country codes used to select extra-eu trade only below
eu_codes <- reporter_names$reportercode
```

## Load from database and update data cache
```{r eval=FALSE}
yearly_tbl <- tbl(con, 'raw_comext_yearly_env_impact') %>% 
    # Only imports
    filter(flowcode == 1L &
               # Only Extra-EU partners
               !partnercode %in% eu_codes) %>% 
    select(c("reportercode", "reporteriso", "partnercode", "partneriso", 
             "productcode", "flowcode", "statregime", "unitcode", 
             "period", "tradevalue", "weight", "quantity"))
# Display the generated SQL query
print(show_query(yearly_tbl))
# Load the yearly table from the database to the memory
system.time(
    yearly <- yearly_tbl %>% collect()
)

# With 7 products:
# user  system elapsed 
# 1.706   0.310  76.138 
# With 63 products:
#   user  system elapsed 
# 25.017   2.662 697.931 

# Place taken in memory
print(object.size(yearly), units = "auto")
rm(yearly_tbl)

# Backup the output of the query
saveRDS(yearly, "data_raw/env_impact/extra_eu_bio_imports.rds")

```


# Read from cache
```{r}
system.time(
    yearly <- readRDS("data_raw/env_impact/extra_eu_bio_imports.rds")
)
# 15 seconds for 63 countries
#   user  system elapsed 
# 14.999   0.382  15.389 

yearly <- yearly %>% 
    mutate(year = period %/% 100,
           productcode2d = substr(productcode, 1,2)) 

```


# Disconnect from the DB
```{r}
RMariaDB::dbDisconnect(con)
```

