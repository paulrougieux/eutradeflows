---
title: "Extract unique product codes from the Comext Combined Nomenclature codes"
output:
  html_document:
    toc: true
---

```{r setup, message=FALSE, warning=FALSE, echo=FALSE}
library(knitr)
opts_knit$set(root.dir="..") # file paths are relative to the root of the project directory
library(tradeflows)
library(dplyr)
library(tidyr)
library(ggplot2)
``` 

```{r dbConnect}
con <- RMySQL::dbConnect(RMySQL::MySQL(), dbname = "tradeflows")
```


# CSV explort example with UK data
## UK import from Indonesia
```{r}
tbl(con, "vld_comext_reporter") %>% collect() %>% 
    filter(grepl("Kingdom", reporter))
# UK reportercode is 6
tbl(con, "vld_comext_partner") %>% collect() %>% 
    filter(grepl("Indonesia",partner))
# Indonesia partnercode is 700
# recent data
wpukind_r <- tbl(con, "raw_comext_monthly_201709") %>% 
    filter(reportercode == 6 & partnercode == 700) %>% 
    addproreppar2tbl(con, .) %>% 
    # show_query() %>% 
    collect()

# archive data
wpukind_a <- tbl(con, "raw_comext_monthly_2016S1") %>% 
    filter(reportercode == 6 & partnercode == 700) %>% 
    addproreppar2tbl(con, .) %>% 
    collect()


# bind archive and recent data, keep only imports
wpukind <- rbind(wpukind_a, wpukind_r) %>% 
    filter(flowcode == 1)

# keep only product 44
wpukind44 <- wpukind %>% filter(productcode == 44)
wpukind44182080 <- wpukind %>% filter(productcode == 44182080)

# Keep only furniture product 94
wpukind94 <- wpukind %>% filter(productcode == 94)
wpukind94036090 <- wpukind %>% filter(productcode == 94036090)

write.csv(wpukind44, "/tmp/comext/ukindonesia44.csv")
write.csv(wpukind94, "/tmp/comext/ukindonesia94.csv")
# 2 highest traded products at the 8 digit level

write.csv(wpukind44182080, "/tmp/comext/ukindonesia44182080.csv")
write.csv(wpukind94036090, "/tmp/comext/ukindonesia94036090.csv")


# keep only product with highest import in value over the period
# Calculate highest import value
wpukind %>% group_by(productcode) %>% 
    summarise(tradevalue = sum(tradevalue)) %>% 
    arrange(desc(tradevalue))

# Wood products
ggplot(wpukind44, 
       aes(x = as.factor(period), y = tradevalue)) +
    geom_point() + ylab("Trade value in 1000â‚¬")
lubridate::ym(c("201001"))
```


## List of VPA countries
```{r}

```

# Spread data along the period
In short: 
statregime should be included, otherwise there are duplications of the 
trade flows.
```{r}
productanalysed <- "44071091"
# Get recent montly data for one product
dtfr <- tbl(con, "raw_comext_monthly_201709") %>%
    filter(productcode == productanalysed) %>%
    # Add quantity units
    eutradeflows::addunit2tbl(con, maintbl = .,
                              tableunit = "vld_comext_unit")  %>%
    collect()


# Spread the data as-is returns an error
if(FALSE){
    dtfr %>% 
        select(ends_with("code"), period, quantity) %>% 
        spread(period, quantity)
}
# Error: Duplicate identifiers for rows (907, 908), (933, 934), (723, 724), (744, 745),
# There are indeed duplicated rows
dtfr[907:908,]

# Creating an additional index as explained in StackOverflow answers
# https://stackoverflow.com/a/44511254/2641825
# https://stackoverflow.com/a/43259735
dtfr %>% 
    select(ends_with("code"), period, quantity) %>% 
    group_by(period) %>%
    mutate(id = 1:n()) %>%
    spread(period, quantity)
# Leads to a lot of empty slots
# In fact I needed to add the statregime column

# Create an index uniting the following columns:
#     reportercode, partnercode, productcode, flowcode, statregime
# Check replications of that index and an idrep column marking index replication
dtfr %>% 
    select(ends_with("code"), period, quantity, statregime) %>% 
    group_by(period) %>%
    unite(id, reportercode, partnercode, productcode, flowcode, statregime,
          remove = FALSE) %>% 
    # mutate(idrep = cumsum(duplicated(id))) %>% 
    spread(period, quantity)
```


```{r disconnectfromDB}
RMySQL::dbDisconnect(con)
```

