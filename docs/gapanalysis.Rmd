---
title: "Gap analysis"
output:
  pdf_document: 
    fig_caption: yes
    number_sections: yes
    toc: yes
  html_document:
    toc: true
---

```{r setup, message=FALSE, warning=FALSE, echo=FALSE}
# Render this long document in a separate bash console with the command:
# cd ~/R/eutradeflows && Rscript -e "rmarkdown::render('docs/gapanalysis.Rmd')"
#
library(knitr)
opts_knit$set(root.dir="..") # file paths are relative to the root of the project directory
library(eutradeflows)
library(dplyr)
library(tidyr)
library(ggplot2)

# Use rotated text at some point to place country names in table heading
# https://tex.stackexchange.com/questions/201696/how-to-rotate-text-in-a-cell-and-center-it-vertically-and-horizontally
``` 


Connect to the database.
```{r dbConnect}
con <- RMySQL::dbConnect(RMySQL::MySQL(), dbname = "tradeflows")
```


# Introduction
Following analysis is based on the most recent data between January 2015 and June 2017, downloaded from the [Eurostat Comext bulk repository](http://ec.europa.eu/eurostat/estat-navtree-portlet-prod/BulkDownloadListing?sort=1&dir=comext) folder 201708.

Descriptive queries on the database table raw_comext_monthly :
```{sql rowsintable, connection=con}
select count(*) from raw_comext_monthly_201708;
```

```{sql periods, connection=con}
select distinct(period) from raw_comext_monthly_201708;
```


# Gaps in trade value
Number of database rows for which the trade value is equal to 0. 
```{r gapsintradevalue}
gtv <- tbl(con, "raw_comext_monthly_201708") %>% 
    filter(tradevalue == 0) %>% 
    group_by(productcode, reportercode, period) %>% 
    summarise(n = n()) %>% 
    left_join(tbl(con, "vld_comext_reporter"), by="reportercode") %>% 
    collect() %>% ungroup() %>%  
    mutate(productcode = as.character(productcode),
           prod2 = as.numeric(substr(productcode, 1,2)))
gtv %>%
    group_by(reporter, prod2) %>% 
    summarise(n = sum(n)) %>% 
    left_join(tradeharvester::products2harvest, 
              by = c("prod2" = "productcode")) %>% 
    unite(product, prod2, productdescription) %>% 
    spread(product, n, fill="") %>% 
    kable()

gtv %>%
    mutate(year = substr(as.character(period),1,4)) %>% 
    group_by(reporter, year) %>% 
    summarise(n = sum(n)) %>% 
    spread(year, n, fill="") %>% 
    kable()
```


Heat map plots inspired by a blog post on 
[learnr.wordpress.com](https://learnr.wordpress.com/2010/01/26/ggplot2-quick-heatmap-plotting/).

```{r ,fig.cap="Number of gaps in trade value by country and period", fig.height=10}
gtv_period <- tbl(con, "raw_comext_monthly_201708") %>% 
    filter(tradevalue == 0) %>% 
    group_by(reportercode, period) %>% 
    summarise(n = n()) %>% 
    left_join(tbl(con, "val_comext_reporter"), by = "reportercode") %>% 
    collect() %>% 
    mutate(period = as.character(period))

ggplot(gtv_period, aes(reporter, period)) +
    geom_tile(aes(fill = n), colour = "white") + 
    scale_fill_gradient(low = "white", high = "steelblue") +
    theme(axis.text.x = element_text(angle = 60, hjust = 1))
```


```{r ,fig.cap="Number of gaps in trade value by country and product"}
gtv_product <- tbl(con, "raw_comext_monthly_201708") %>% 
    filter(tradevalue == 0) %>% 
    group_by(reportercode, productcode) %>% 
    summarise(n = n()) %>% 
    left_join(tbl(con, "val_comext_reporter"), by = "reportercode") %>% 
    collect() %>% 
    mutate(productcode = as.character(productcode),
           p4 = substr(productcode, 1,4)) 

#
ggplot(gtv_product, aes(reporter, p4)) +
    geom_tile(aes(fill = n), colour = "white") + 
    scale_fill_gradient(low = "white", high = "steelblue") 

# More detailed plot
ggplot(gtv_product, aes(reporter, productcode)) +
    geom_tile(aes(fill = n), colour = "white") + 
    scale_fill_gradient(low = "white", high = "steelblue") 
```
There was a time in 2015 where Croatia had a great number of gaps
in the trade value, but in 2017, this has been mostly fixed.


# Gaps in weight data
```{r}
tbl(con, "raw_comext_monthly_201708") %>% 
    filter(productcode == 44) %>% 
    filter(is.na(weight))
```

## Plot weight gap by country
```{r}
wg <- tbl(con, "raw_comext_monthly_201708") %>% 
    filter(productcode == 44) %>% collect()
```
In the current version empty values have the value 0, 


# Gaps in volume data
```{r}

```


# Issues
## 20170825 Issue with the encoding of empty values mysql NULL, R NA
How are empty values encoded in the text file?
```{bash eval=FALSE}
cp ~/R/tradeharvester/data-raw/comext/201708/data/nc201501.7z /tmp/comext
cd /tmp/comext/
7zr e nc201501.7z 
# Extract all productcode starting with 44
awk -F, '$3 ~ /^44/' nc201501.dat | less
```

In `less`, search for /2675.752 
Empty value is represented by an empty string at the end of the line.
Compared for example the end of the 2 lines below:
```
001,0053,44,1,4,201501,2675.752,3247.776,
001,0053,44032011,2,4,201501,35.48,391.5,870
```

Can this be read as NA instead of 0?
How about in the middle of the line?
It seems empty values are then encoded as "0" when in the middle of the line:
```
003,0960,44,1,4,201501,0.157,0,
003,0960,44,2,4,201501,0.141,0.003,
003,0960,44190090,2,4,201501,0.139,0.003,
003,0960,44MMM000,1,4,201501,0.157,0,
003,0960,44MMM000,2,4,201501,0.002,0,
```

Disconnect from the database.
```{r dbDisconnect}
RMySQL::dbDisconnect(con)
```

